---
layout: post
title: "Finding and Cleaning Up EMLs That Display HTML Codes as Text"
date: 2012-06-22
---

<div class="post-body">
<p>I had a bunch of email (EML) files scattered around my hard drive.  Some of them, I noticed, were displaying a lot of HTML codes.  For example, when I opened one (using Thunderbird as the default EML opener), it began with this:<br/>
<br/>
<pre wrap="">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN"&gt;
&lt;HTML&gt;
&lt;HEAD&gt;
&lt;META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1"&gt;
&lt;META NAME="Generator" CONTENT="MS Exchange Server version 6.5.7036.0"&gt;
&lt;TITLE&gt;RE: Scholar Program&lt;/TITLE&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;
&lt;!-- Converted from text/rtf format --&gt;</pre>
<div wrap="">
<br/></div>
<div wrap="">
I was not sure how that happened.  Apparently I had run these EMLs through some kind of conversion process, perhaps after renaming them to be .txt files.  Whatever the origin, I wanted to eliminate all those HTML codes and wind up with a plain text file, probably saved as a PDF.  This post describes the steps I took to achieve that outcome.<br/>
<br/>
<strong>Finding the Offending Files</strong></div>
<div wrap="">
<br/></div>
<div wrap="">
As I say, the files containing this text were scattered.  Initially, I did a search for some of the text shown above (specifically, for "&lt;!DOCTYPE HTML PUBLIC") in <a href="https://web.archive.org/web/20151121002852/http://www.copernic.com/en/products/desktop-search/index.html" target="_blank">Copernic</a>.  (I assume any tool capable of searching for text within files would work for this purpose.)  I thought maybe I would just copy and paste the lot of them from Copernic to a separate folder in Windows Explorer, where I could work on them in more detail.  This approach was not working very well because failed because Copernic did not allow me to select and move multiple files to other folders.  Moreover, Copernic did not display them with their actual filenames; rather, it showed the title indicated in the HTML "&lt;TITLE&gt;" line (see example above).</div>
<div wrap="">
<br/></div>
<div wrap="">
It was probably just as well.  Moving them in bulk from Copernic would have lost the indications of the folders where they were originally located.  The better approach, I decided, would be to use the command line and batch files to identify their source folder, move them to a single folder where I could work on them, and then move the resulting, cleaned-up files back to the folders where the originals had come from.</div>
<div wrap="">
<br/></div>
<div wrap="">
So the first thing I needed was a way to locate the files to be cleaned up.  I decided to use a batch command for this purpose.  I could have searched for every file (or just every EML file) that contained any HTML codes.  For that purpose, a search for "&lt;/" might have done the trick.  But then I decided that there could be a lot of HTML codes floating around out there, in various files, for a lot of different reasons; and for present purposes I didn't need to be trying to figure out what was happening in all those different situations.  So instead, I searched for the same thing as before:  "&lt;!DOCTYPE HTML PUBLIC."  To do that, after several false starts, I tried this command:</div>
<div wrap="">
<blockquote class="tr_bq">
findstr /r /m /s "&lt;!DOCTYPE HTML PUBLIC" D:\*.eml &gt; D:\findlist.txt</blockquote>
It produced a dozen "Cannot open" error messages.  The reason seemed to be that the filenames for those files had funky characters (e.g., #, §).  Also, Findlist.txt contained the names of files that did not seem to have the DOCTYPE text specified in the command.  DOCTYPE may have appeared in attachments to those files, but I didn't want to be flagging that sort of EML file.  So despite a number of variations with FINDSTR and several <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;hs=08o&amp;rls=org.mozilla:en-US:official&amp;sa=X&amp;ei=SuDfT6XxHYO-2gWQmYmMCg&amp;ved=0CAcQvgUoAA&amp;q=EMLs+display+HTML+codes&amp;nfpr=1&amp;biw=1114&amp;bih=902" target="_blank">Google searches</a>, I gave up.  I returned to Copernic, searched for the DOCTYPE text (in quotation marks, as shown above), and moved them manually.  Copernic had a convenient right-click Move to Folder option, so that helped a little.  So now, anyway, despite the imperfections of the process, I apparently had the desired EMLs in a single folder.  I would just have to re-sort them back to where they belonged manually.<br/>
<br/>
But I still wasn't sure that everything in that folder was problematic.  Basically, I needed to see what the EMLs looked like when they were opened up.  Ideally, I would have just clicked a button at this point to convert them to PDF and merge them into a single document, so I could just flip through and identify the problem emails.  But I was having <a href="https://web.archive.org/web/20151121002852/http://raywoodcockslatest.blogspot.com/2012/06/exporting-thunderbird-emails-to-pdf.html" target="_blank">problems</a> in my efforts to print EMLs as PDFs.  As a poor second-best, I manually opened them all (again, using Thunderbird as my default EML opener), selected the ones needing repair in Windows Explorer, and moved them to a separate folder.  To open them, I just did a "DIR /b /a-d &gt; Opener.bat" and modified its contents, using Excel, so that each one started and ended with a quotation mark (actually, CHAR(34)) -- no other command needed -- and then ran Opener.bat.  Somehow, this failed to crash my system.<br/>
<br/>
<b>Cleaning Up the Files</b><br/>
<br/>
After verifying that most of them looked bad (and removing the others), I made copies in another folder, and renamed the copies to .TXT extensions using <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?q=%22Bulk+Rename+Utility%22&amp;ie=utf-8&amp;oe=utf-8&amp;aq=t&amp;rls=org.mozilla:en-US:official&amp;client=firefox-a" target="_blank">Bulk Rename Utility</a>.  Now I could edit them as text files.  My plan was to store up a set of standard search-and-replace items, mostly replacing HTML codes with nothing at all, so as to clean up these files.<br/>
<br/>
I had <a href="https://web.archive.org/web/20151121002852/http://raywoodcockslatest.blogspot.com/2011/12/windows-7-archiving-emails-from.html" target="_blank">previously</a> decided on Emacs as my default hard-core text editor, and had taken some <a href="https://web.archive.org/web/20151121002852/http://raywoodcockslatest.blogspot.com/2012/03/choosing-emacs-as-text-editor-with.html" target="_blank">first steps</a> in re-learning how to use it.  The task at hand was to find advice on how to set up before-and-after lists of text strings to be replaced.  It was probably something I could have done in Excel, but I might have had to cook up a separate spreadsheet for each file, and here I was wanting to modify multiple files -- dozens, possibly hundreds -- in one operation.  Now, unfortunately, it was looking like Emacs was not going to be as naturally adapted to this task as I had assumed.  After a couple of tries, I found <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;hs=BzR&amp;rls=org.mozilla%3Aen-US%3Aofficial&amp;q=Emacs+search+OR+find+%22multiple+strings%22+OR+%22several+strings%22&amp;oq=Emacs+search+OR+find+%22multiple+strings%22+OR+%22several+strings%22&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_l=serp.3...84663.104963.0.105194.42.34.0.0.0.1.389.3599.15j17j1j1.34.0...0.0.zUD75u3Xugs" target="_blank">a search</a> that did bring up a <a href="https://web.archive.org/web/20151121002852/http://stackoverflow.com/questions/698596/regex-to-match-multiple-strings" target="_blank">couple</a> of <a href="https://web.archive.org/web/20151121002852/http://stackoverflow.com/questions/8682079/batch-replace-a-bunch-of-strings-in-a-text-file-with-emacs" target="_blank">solutions</a> to <a href="https://web.archive.org/web/20151121002852/http://stackoverflow.com/questions/2588277/how-can-i-swap-or-replace-multiple-strings-in-code-at-the-same-time" target="_blank">related</a> problems.  But those solutions still looked pretty manual.  Was there some more tried-and-true tool or method for replacing multiple text strings in multiple files?<br/>
<br/>
<a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;hs=WL7&amp;rls=org.mozilla%3Aen-US%3Aofficial&amp;q=search+OR+find+replace+%22multiple+strings%22+OR+%22several+strings%22+%22text+files%22&amp;oq=search+OR+find+replace+%22multiple+strings%22+OR+%22several+strings%22+%22text+files%22&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_l=serp.3...784789.792815.0.793079.26.19.1.0.0.1.405.2209.9j8j1j0j1.19.0...0.0.Wsj1QojBuLE" target="_blank">A different search</a> led to <a href="https://web.archive.org/web/20151121002852/http://www.hothotsoftware.com/findandreplacetextinfiles_software/findAndReplaceTextRegularExpressionsEval_purchasepage.php" target="_blank">HotHotSoftware</a>, which offered a tool for this purpose for $30.  <a href="https://web.archive.org/web/20151121002852/http://www.youtube.com/watch?v=OmkgCQ-CkvQ" target="_blank">A video</a> seemed to demonstrate that it would work.  But, you know, $30 was more than the files were worth.  Besides, I wouldn't learn anything useful that way.  <a href="https://web.archive.org/web/20151121002852/http://www.mind-pioneer.com/replace/page_demo.html?http://www.mind-pioneer.com/services/Advanced_search_and_replace.html" target="_blank">ReplacePioneer</a> ($39, 21-day trial) looked like it might also do the job.  <a href="https://web.archive.org/web/20151121002852/http://www.vistax64.com/vb-script/189303-newbie-question-replace-multiple-strings-multiple-text-files.html" target="_blank">A thread</a> offered a way to do something like it in an unspecified language, presumably Visual Basic.  <a href="https://web.archive.org/web/20151121002852/http://www.unix.com/unix-dummies-questions-answers/143054-best-method-replacing-multiple-strings-multiple-files-sed-awk-most-simple-preferred-3.html" target="_blank">Another thread</a> offered an approach in sed.  Another way to not learn anything, but also not to spend $30, was to try the free <a href="https://web.archive.org/web/20151121002852/http://sw.ixoft.com/texfinderx/" target="_blank">TexFinderX</a>.  Other free options included Nodesoft <a href="https://web.archive.org/web/20151121002852/http://www.nodesoft.com/searchandreplace" target="_blank">Search and Replace</a> and <a href="https://web.archive.org/web/20151121002852/http://www.ecobyte.com/replacetext/" target="_blank">Replace Text</a>.<br/>
<br/>
I tried TexFinderX.  In its File &gt; Add Folder menu pick, I added the list of files to be changed.  I clicked the Replacement Table button, but did not see the Open Table Folder button shown on <a href="https://web.archive.org/web/20151121002852/http://sw.ixoft.com/texfinderx/" target="_blank">the webpage</a>.  The ReadMe file seemed to say that a new replacement table would appear in the list only after being manually created in the TFXTables subfolder.  They advised using an existing table to create a new one.  As I viewed their "Accented to None - UTF8.txt" replacement table, I recalled looking into character replacement using <a href="https://web.archive.org/web/20151121002852/http://raywoodcockslatest.blogspot.com/2012/03/excel-2003-cleaning-nonstandard.html" target="_blank">Excel formulas</a>.  The specific point of comparison was that I had discovered, in that process, that people had invented various character conversion tables that might be suitably implemented with TexFinderX.<br/>
<br/>
But for my own immediate purposes, I needed to see if a TexFinderX replacement table would accept a whole string of characters, to be replaced by nothing or, say, a single space.  I was hoping that what I was seeing, there in that "Accented to None" replacement table, was that the "before" and "after" columns were tab-delimited -- that, in other words, I could enter a whole long string, hit the tab key, and then hit the spacebar.  I tried that, first saving the "Accented to None" table under the name of "Remove HTML Codes," and then entering "&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD W3 HTML//EN"&gt;" (without the outside quotation marks, of course) and hitting Tab and then Space.  I did this on what appeared to be the first replacement line in that "Accented to None" file, right after the line that said /////true/////, as guided by the ReadMe.  I hit Enter at the end of that line, and deleted everything after it, removing all the commands they had provided.  I also changed the top lines, the ones that explained what the file was about.  I saved the file, went into the program's Replacement Table button, and there it was.  I selected it and clicked Apply.  On second thought, I decided to try it on just one or two files, so I emptied out the list and added back just a couple of files.  Then I ran it.  It looked like it worked.<br/>
<br/>
I proceeded to add all kinds of other HTML codes to my new Remove HTML Codes replacement table, testing and running and removing more unwanted stuff.  I found that it was not necessary to hit Tab and then Space at the end of each line that I wanted to remove; it would remove anything that was on a line by itself, where no other tab-delimited text followed it on the same line.  So, basically, I could copy and paste whole chunks of unwanted text into the replacement table, and it would be removed from any files on the list that happened to contain it.  It seemed best not to add too many chunks at once, lest I be repeating the same lines:  run a few, after eyeballing them for duplication, and then see what was left.  It appeared that I could add comments, on these lines in the replacement table, by again hitting Tab after the "replace" value on the line.<br/>
<br/>
I added back some of their original items (modified) to the replacement table.  These included the replacement of three spaces with two (which I might run several times to be thorough); the replacement of a Space-CR (Carriage Return) combination with a simple CR (using space-&lt;13&gt; tab &lt;13&gt; to achieve that, and <a href="https://web.archive.org/web/20151121002852/http://www.theasciicode.com.ar/ascii-control-characters/carriage-return-ascii-code-13.html" target="_blank">apparently</a> doing the same thing also with &lt;10&gt; in place of &lt;13&gt;).  I tried replacing three CRs with two, using &lt;13&gt;&lt;13&gt;&lt;13&gt; on the same line, but it didn't work.  The answer to that seemed to be to replace three pairs of &lt;13&gt;&lt;10&gt; with two.  I discovered that the conversion process that had mangled these files originally had placed different parts of HTML code sequences on different lines, so I had to break them up into smaller pieces -- but not too small, because I didn't want to be accidentally deleting real text from my emails that happened to look similar to these HTML codes.<br/>
<br/>
I basically worked through all the codes that appeared in one email, and then started in on those that remained in the next after applying my accumulated rules to it, and so forth.  After working through the first half-dozen files in the list, I skipped down and ran the accumulated corrections against some others.  Running it repeatedly seemed to clear up some issues; possibly it was able to process only one change per line per run.  I realized that it would probably not produce perfect results across all cases.  It was succeeding, however, in giving me readable text that had previously been concealed beneath a mountain of HTML codes.<br/>
<br/>
I had noticed that the program took a little longer to run as I added more rules to its replacement table.  But this did not seem to be due to file processing time:  the time did not grow far longer when I added far more files to the list.  It was still done within a minute or so in any case.  Apparently it was just reading the instructions into memory.<br/>
<br/>
The excess (now blank) lines in the files were the slowest to remove.  I ran TexFinderX against the whole list of files at least a half-dozen times, adding a few more codes with the aid of additional spot checks.  Unless I was going to check every individual file for additional lingering codes, that appeared to be about as far as TexFinderX was going to take me in this project.<br/>
<br/>
<b>Cleaning Up the Starts and Ends of Files</b><br/>
<br/>
href="http://raywoodcockslatest.blogspot.com/2012/03/choosing-emacs-as-text-editor-with.html" target="_blank"&gt;previouslyused Emacs to eliminate unwanted ending material from files.  Now I wanted to use a similar process on these files.  I also wanted to see if I could adapt that process to remove unwanted material elsewhere in the files.<br/>
<br/>
I had not previously noticed that most if not all of these emails had originally included attachments.  As such, they included certain lines after their text, apparently announcing the beginning of the attachment portion.  These lines included indications of Content-Type, Content-Transfer-Encoding, and Content-Disposition.  These seemed like good places to identify the start of ending material to delete, for purposes of printing a cleaned-up message portion by itself.  I now saw that I had made things more difficult for myself by including references to some Content-Type and Content-Transfer-Encoding lines in my list of items to remove in TexFinderX.  I had not removed Content-Disposition lines, however, so -- as in the previous use of Emacs -- those would be my focus.<br/>
<br/>
Having already done the initial setup of <a href="https://web.archive.org/web/20151121002852/http://www.gnu.org/software/emacs/" target="_blank">GNU Emacs</a> as described in the previous post, I set forth to modify the process that I had used previously.  After making a backup, the summary version of those steps, as modified, went like this:<br/>
<ul>
<li>Start Emacs.  Open one of the post-TexFinderX emails.  Hit F3 to start macro recording.  C-End (that is, Ctrl-End, in <a href="https://web.archive.org/web/20151121002852/http://www.cs.rutgers.edu/LCSR-Computing/some-docs/emacs-chart.html" target="_blank">Emacs-speak</a>) to go to the file's end.  Hit C-r and type "Content-Disposition" to back up to its last occurrence of Content-Disposition.</li>
<li>At this point, modify the previous approach to back up a bit further, in search of the boundary line just preceding the Content-Disposition line.  I could have done this by hitting C-r and typing "----------" to find that boundary line, but now I saw that my TexFinderX replacements had deleted that, too, from some of these emails.  So instead, I just hit the Up arrow three times, hoping that that would take me to a point before most of the ending material.</li>
<li>Hit C-space to set the mark.  C-End.  Del.</li>
</ul>
<div>
The macro was still recording; I wasn't done.  The preceding steps did take care of the ending material in that particular file.  (As before, it was essential to avoid typographical errors, which would terminate macro recording or worse.)  But now, how about the unwanted starting material? I hadn't done this particular operation before, but it seemed straightforward enough.  I had to use C-Home to get to the start of the file.  Then -- since I had, again, deleted the objectionable boundary lines in some of these emails -- I had to search for the last surviving <a href="https://web.archive.org/web/20151121002852/http://people.dsv.su.se/~jpalme/ietf/mail-headers/mail-headers.html" target="_blank">message header field</a>.  In the case of the first email I was looking at, which I believed was probably the most thoroughly scrubbed, that last surviving field was Message-ID.  So I went through several additional but similar steps to clean up the start of the email and finish the task:</div>
<div>
<ul>
<li>C-s to search for Message-ID.  Then C-e to go to the end of that line, and right-arrow to go to the start of the next line.  C-Space to set the mark, C-Home, and then Del.  That was as much as I could do with this particular email; it was clean, though not ideally formatted.</li>
<li>C-x C-s to save the file.  F4 to end the macro recording.  C-x C-k n Macro1 Enter (to name the macro to be Macro1).  C-x C-k b 1 (to bind the macro to key 1).</li>
<li>C-x C-f ~/ Enter (to find my Emacs <a href="https://web.archive.org/web/20151121002852/http://stackoverflow.com/questions/10112663/home-directory-and-emacs-file-in-windows-7" target="_blank">Home directory</a>).  In my case, Home was 
C:\Users\Ray\AppData\Roaming\.emacs.d.  I went there in Windows Explorer and created a new text file named _emacs, with no extension.  This was my init file.</li>
<li>From the Emacs menu:  File &gt; Open File &gt; navigate to the new _emacs init file &gt; select and open _emacs.  Using the Meta (i.e., Alt) key, I used M-x insert-kbd-macro Enter Macro1 Enter.  This hopefully saved my macro to my init file.  C-x C-c to save and quit Emacs.  A quick look with Notepad confirmed that there was something in _emacs.</li>
<li>Restart Emacs.  Open another of these text emails.  Test my macro by typing C-x C-k 1.  I got "C-x C-k 1 is undefined." I killed Emacs and, following <a href="https://web.archive.org/web/20151121002852/http://www.gnu.org/software/emacs/manual/html_node/emacs/Find-Init.html#Find-Init" target="_blank">advice</a>, in Windows Explorer I renamed _emacs to be init.el and tried again.  Still undefined.  Since _emacs had worked in my previous session, I decided that the advice about init.el might be oriented toward Unix rather than Windows systems, so I changed it back to _emacs.  In the Emacs menu, I went to File &gt; Open File &gt; navigate to _emacs &gt; open _emacs.  I used C-x 2 to split the window.  _emacs appeared in both panes.  In the top pane, I went to Buffers &gt; select the text file to be changed.  (Apparently it was listed as one of the available buffers because I had already opened it.)  So now I was viewing the macro in the bottom pane and the email file in the top pane.  I selected the top pane and tried C-x C-k 1 again; still undefined.  I found <a href="https://web.archive.org/web/20151121002852/http://lpn.rnbhq.org/tools/xemacs/emacs_ref.html" target="_blank">other advice</a> to just use M-x Macro1.  That worked.  The macro ran in the top pane.</li>
</ul>
<div>
The macro didn't do such a great job of cleaning this second file.  I would have to return to that later.  For now, the next step was to figure out how to run the macro automatically on all the emails.  Meager results from <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;rls=org.mozilla%3Aen-US%3Aofficial&amp;pws=0&amp;q=Emacs+%22macro+on+multiple+files%22+OR+%22macros+on+multiple+files%22&amp;oq=Emacs+%22macro+on+multiple+files%22+OR+%22macros+on+multiple+files%22&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_l=serp.3...111376.119174.0.119737.11.9.0.0.0.0.315.1360.1j6j1j1.9.0...0.0.zmZb8ruWPw8" target="_blank">a search</a> presented the possibility that people did not commonly do this sort of thing.  <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;rls=org.mozilla%3Aen-US%3Aofficial&amp;pws=0&amp;q=Emacs+%22run+a+macro%22+OR+%22run+macros%22+%22multiple+files%22+-Excel&amp;oq=Emacs+%22run+a+macro%22+OR+%22run+macros%22+%22multiple+files%22+-Excel&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_l=serp.3...16644.17637.0.17859.7.7.0.0.0.0.261.1020.3j3j1.7.0...0.0.H8m0pRE4PWc" target="_blank">A refined search</a> led to <a href="https://web.archive.org/web/20151121002852/http://unix.stackexchange.com/questions/4111/how-can-i-manipulate-the-content-of-a-file-by-duplicating-and-changing-some-par" target="_blank">further discussion</a> suggesting that I should be searching for information on multiple buffers rather than multiple files.  <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;rls=org.mozilla%3Aen-US%3Aofficial&amp;pws=0&amp;q=Emacs+%22run+a+macro%22+OR+%22run+macros%22+%22multiple+buffers%22+-Excel&amp;oq=Emacs+%22run+a+macro%22+OR+%22run+macros%22+%22multiple+buffers%22+-Excel&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_l=serp.3...180130.181882.0.183397.10.10.0.0.0.2.153.888.7j3.10.0...0.0.hhThJV4YEaM" target="_blank">That innovation</a> provoked the <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;hs=ka3&amp;rls=org.mozilla%3Aen-US%3Aofficial&amp;q=allintitle%3A+jedit+Emacs&amp;oq=allintitle%3A+jedit+Emacs&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_l=serp.3...9662.11559.0.12598.12.10.0.0.0.3.655.1655.4j4j0j1j0j1.10.0...0.0.YtoMfsaYRoA" target="_blank">side question</a> of whether perhaps <a href="https://web.archive.org/web/20151121002852/http://www.jedit.org/" target="_blank">jEdit</a> was better than Emacs for such purposes but, once again, Emacs <a href="https://web.archive.org/web/20151121002852/http://text-editor.pikimal.com/vs/gnu-emacs/jedit" target="_blank">seemed better</a>.  Still <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;rls=org.mozilla%3Aen-US%3Aofficial&amp;pws=0&amp;q=Emacs+macros+%22multiple+files%22+OR+%22multiple+buffers%22+-Excel&amp;oq=Emacs+macros+%22multiple+files%22+OR+%22multiple+buffers%22+-Excel&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_l=serp.3...436998.446112.0.446396.58.49.0.0.0.0.257.5304.25j21j3.49.0...0.0.BLlwidM2ac8" target="_blank">another search</a> led to <a href="https://web.archive.org/web/20151121002852/http://www.gnu.org/software/emacs/manual/html_node/emacs/Dired.html" target="_blank">Dired</a>, which would apparently allow the user to conduct certain operations on the files listed in a directory.  We were getting closer.  I found <a href="https://web.archive.org/web/20151121002852/http://lists.gnu.org/archive/html/help-gnu-emacs/2009-07/msg00492.html" target="_blank">someone</a> who was feeling my pain, but without a solution.</div>
<div>
<br/></div>
<div>
A <a href="https://web.archive.org/web/20151121002852/http://stackoverflow.com/questions/1472700/emacs-keyboard-macros-and-dired" target="_blank">StackOverflow discussion</a> suggested that I might want to begin a Dired approach by loading kmacro.  I had no idea of how to do this.  An <a href="https://web.archive.org/web/20151121002852/http://www.gnu.org/software/emacs/manual/html_node/emacs/Keyboard-Macro-Counter.html" target="_blank">Emacs manual page</a> seemed to think that kmacro was already part of Emacs.  I decided to try to follow the StackOverflow concepts without special attention to kmacro preliminaries.  The first recommended step was to go to the top of my Dired buffer.  This, too, was a mystery.  Another <a href="https://web.archive.org/web/20151121002852/http://www.gnu.org/software/emacs/manual/html_node/emacs/Dired-Enter.html#Dired-Enter" target="_blank">Emacs manual page</a> told me to use C-x d to start Dired.  In the bottom line of the screen, that displayed the name of the directory containing the emails.  I didn't know what else to do, so I hit Enter.  Apparently that was just the right thing to do:  it showed me a directory listing for that folder.  It would develop, eventually, that the fast way to get it to show that directory was to use the menu option File &gt; Open File to navigate to that directory and open a file there.</div>
<div>
<br/></div>
<div>
Now the StackOverflow advice was apparently to move the cursor to the first file in that list (which is where it already looked like it might be) and hit F3 to begin recording a keyboard macro.  Then hit Enter to visit the file.  Then M-x kmacro-call-ring-2nd.  But at this point it said, "No keyboard macro defined."  So kmacro was working, but on this command Dired was looking for a previous keyboard macro, not for an already saved one.  I used C-x k Enter to close the email that I had opened.  Now I was back at the Dired file list.  I hit C-x 2 to split the window, so maybe I could see more clearly what was going on.  With the cursor on the first target email in the top pane, I hit Enter to visit it again, then M-x Macro1 Enter.  That seemed to be the answer, sort of:  the bottom row said, "After 0 kbd macro iterations: Keyboard macro terminated by a command ringing the bell."  So the macro did try to run.  Adventures in the previous post suggested that this error message meant the macro failed to function properly, and I believed I knew why:  this was the email that I had already edited.  I had already removed, that is, the stuff that the macro was searching for, starting with the Content-Disposition line.</div>
<div>
<br/></div>
<div>
Time to try again.  With the top pane (displaying the email message) selected, I hit C-x k Enter to close it.  Then I moved the cursor to (i.e., mouse-clicked on) an email on which I had not yet run Macro1.  There, going back to the (modified) StackOverflow advice, I hit F3 to start recording a keyboard macro; I hit Enter to visit the file; then M-x Macro1 Enter.  It ran without an error message.  The email was showing in both top and bottom panes, so evidently I had not yet mastered the art of pane.  StackOverflow said C-x o to switch to the other buffer.  This just switched me to the other pane; I was supposed to be seeing the Dired file list.  With the keyboard macro still recording, I tried C-x k Enter to close the email.  Now the bottom pane, where I was, had the cursor flashing on the wrong line.  C-x o, then., followed by a tap on the down arrow key to take me to the next file to be processed.  That was the end of the steps that I wanted my new keyboard macro to save, so I hit F4.  StackOverflow said that now I had to hit C-u 0 c-x e to run the keyboard macro on every file in the list.  But that command sequence only opened the next file and ran Macro1 on it.  I hit C-x k Enter to close.  I was back at the Dired list.  The cursor did not advance to the next line; Macro1 did not run automatically.</div>
</div>
<div>
<br/></div>
<div>
I thought maybe my errors in that last try screwed up the keyboard macro, so I tried recording it again:  F3; cursor on the target email; Enter to visit that file; M-x Macro1 Enter to run the macro; Ctrl-x k Enter to close the email; down-arrow to select the next email in the list; F4 to close the keyboard macro; C-u 0 C-x e to run it.  No joy:  I still had to close the file and start the next one manually.</div>
<div>
<br/></div>
<div>
By this point, a different approach had occurred to me.  If I could open all the target emails at once, I would only have to hit keys to run Macro1 and then close the changed file:  the next one would then be there, ready and waiting for Macro1.  I decided to try this.  As <a href="https://web.archive.org/web/20151121002852/http://stackoverflow.com/questions/4027106/emacs-open-multiple-files-at-once-in-tabs" target="_blank">advised</a>, with an email already opened in my target directory (via menu pick -- see above), so as to tell Emacs where to look, I used C-x C-f *.txt to open all of those emails. (As noted above, I was working on EMLs that I had mass-renamed to be TXT files.)  That seemed to work.  The first ones visible to me were those at the top of the list, on which I had already run Macro1.  I closed those.  I couldn't tell, from the Buffers menu pick, how many files remained opened.  I could see that their timestamp would change in Windows Explorer after Emacs was done with them, so presumably I would be able to check which ones I had run Macro1 on.  I made a mental note to make at least some kind of change in each file before closing it, so as to assure myself that there was no further need to work it over with Macro1.</div>
<div>
<br/></div>
<div>
So now I was looking at the first file that had not yet been caressed by the loving hand of Macro1.  I wondered:  can I define a keyboard macro to save the steps of running Macro1 and then closing the file?  I tried:  F3, M-x Macro1 Enter, C-x k Enter, F4.  To execute that last defined keyboard macro, I used C-x e.  It changed the file as desired -- that is, apparently it ran Macro1 -- and it also seemed to be saving the changed file, but it did not close the file.  In other words, I had reduced the required number of keystrokes down to C-x e, C-x k Enter.  That was what it took to run Macro1 and then close a file.  Not bad, but could I do better?</div>
<div>
<br/></div>
<div>
The problem -- for both this approach and the Dired approach (above) -- seemed to be that the macros were not saving the C-x k Enter sequence.  <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;hs=91P&amp;rls=org.mozilla%3Aen-US%3Aofficial&amp;q=Emacs+%22macro+to+close%22+-Excel+-dired+-%22all+open%22+-parens&amp;oq=Emacs+%22macro+to+close%22+-Excel+-dired+-%22all+open%22+-parens&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_l=serp.3...6177.7402.0.7652.8.8.0.0.0.0.183.942.3j5.8.0...0.0.1ooQSKKPB_Y" target="_blank">A search</a> seemed to indicate this could be another difficult problem to solve.  I was running low on time for this project, so I had to shelve that, along with the ensuing question of whether I could bind this C-x e C-x k Enter sequence to <a href="https://web.archive.org/web/20151121002852/http://www.xemacs.org/Links/tutorials_2.html" target="_blank">a function key</a>.  </div>
<div>
<br/></div>
<div>
Instead, I just went plodding through that sequence for these many files.  In some cases, the scrollbar at the right showed me that there was a lot of extra material that I had to delete manually, usually from the ends of the emails.  Saving after these additional edits required a C-x C-s Enter before the C-x k Enter.  It was also handy to know that C-/ was the undo key.</div>
<div>
<br/></div>
<div>
<div>
<b>Further Cleanup</b></div>
</div>
<div>
<br/></div>
<div>
When I was done running Macro1 on all those files, I saw that Emacs had created backup copies, with a .txt~ extension.  I sorted by file type in Windows Explorer and deleted those.  Also, while going through the process, I had noticed a number of files that were short and unimportant, and whose attachments did not interest me.  So I was able to go through the list and remove those to a "Ready to PDF" folder.  These steps reduced the number of files on which I might want to perform further operations.</div>
<div>
<br/></div>
<div>
While looking at those files in Windows Explorer, I noticed that some were much larger than others.  These, I suspected, included some whose attachment sections had not been completely eliminated by the macro, perhaps because they had more than one attachment.  I opened these in Notepad and eliminated material that did not contribute to the intelligible text of the email.</div>
<div>
<br/></div>
<div>
In some of the remaining files, there were still a lot of HTML codes and other material that would interfere significantly with an attempt to read the contents.  It seemed that the spot checks I had conducted in TexFinderX had not brought out all of the things that TexFinderX could have cleaned up.  I restarted TexFinderX, added more codes to the list of things to remove, and ran it some additional times on the files remaining in that folder.  That didn't continue too long before I realized that there could be an endless number of such codes and variations.</div>
<div>
<br/></div>
<div>
The next step was to return to Emacs.  This time, I was looking particularly for individual lines that could safely be deleted.  This was not so much a concern with HTML codes, though there might be some of that too; it was more a concern with email headers, boundary lines, and other items that would vary from one email to the next, could therefore not be readily added to a TexFinderX replacement list, and yet could appear repeatedly within a single email.  For example, each of the following lines appeared within a single email:</div>
<div>
<br/>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">--===============3962046403588273==</span></div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">boundary="----=_NextPart_000_002A_01C69314.AD087740"</span></div>
<div>
<span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">------=_NextPart_000_002A_01C69314.AD087740</span></div>
<br/>
<div>
Moreover, variations on those themes recurred throughout that email, with quite a few of each.  So I could write an Emacs macro to search for a line beginning with the relevant characters, select that entire line, and delete it.  I wouldn't have to know which numbers appeared on different variations of these lines, as I would if I were using TexFinderX.</div>
<br/>
<div>
The problem here was that there were quite a few different kinds of lines to remove.  In addition to the types just shown, there were also email header lines that would normally not be visible, but that had become visible in the original mangling of these files, and there were also various Content-Description and Content-Disposition and Content-ID and Content-Location lines.  I would have to write an Emacs macro for each.  I could write one macro to run them all, but it would terminate as soon as it failed to find the next requested line; and since these sorts of lines varied widely from one email to another, it was quite likely that such a general macro would be terminating prematurely more often than not.  If I knew how to bind macros to individual keys, it might not be horrible to go down the list and punch the assigned function (or Ctrl-Function, Alt-Function, etc.) keys, one at a time, reiteratively for each of these many email files.  But that seemed like a lot of work for a fairly unimportant project.  A better approach would have been to write a script to handle such things, but my chosen scripting language for this purpose, Perl, had one significant drawback:  I had not learned it yet.  I had been meaning to, for about 20 years, and I knew that eventually the opportunity would arrive.  But that day was not today.</div>
<div>
<br/></div>
<div>
I concluded that my cleanup phase for these emails was finished.  If I really needed to go further with it, I could convert them from PDF back to text and have at it again, some fine day.  If I had really intended to do that, I would have saved a list of the relevant files at this point.  But for the time being, I needed to get on with the next part of the project.<br/>
<br/>
<b>Converting Emails to PDF</b><br/>
<br/>
I had <a href="https://web.archive.org/web/20151121002852/http://raywoodcockslatest.blogspot.com/2012/03/batch-converting-many-text-files-to-pdf.html" target="_blank">previously</a> used "Notepad /p" to convert a set of TXT files, like these emails, to a set of PDFs.  The basic idea was to make a list of files and then use Excel to convert those file paths and names (as needed) to batch commands.  I used that same approach here, making sure to set the PDF printer operate with minimal dialog interruptions.  This produced PDFs with "Notepad" at the end of their names.  For some reason, Bulk Rename Utility was not able to remove that; I had to use <a href="https://web.archive.org/web/20151121002852/http://www.advancedrenamer.com/" target="_blank">Advanced Renamer</a> instead.</div>
<div>
<br/></div>
<div>
<b>Converting Attachments to PDF</b></div>
<div>
<b><br/></b></div>
<div>
As noted above, most of these troublesome emails had attachments.  I now had, in a folder, only those emails (in .txt format) whose attachments I wanted to see.  Using a DIR command as above, I did a listing of those .txt files.  I put that list into Excel and modified it to produce batch commands that would move the EMLs of the same name to a separate folder.  Then, in Thunderbird, I created a new local folder.  With that folder selected, I went into Tools &gt; ImportExportTools &gt; Import eml file.  I navigated to the folder containing the EMLs whose attachments I wanted to see, selected them all, and clicked Open.  The icons indicated that all did have attachments.</div>
<div>
<br/></div>
<div>
Now, having configured Thunderbird's <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;client=firefox-a&amp;hs=DXm&amp;rls=org.mozilla%3Aen-US%3Aofficial&amp;q=Thunderbird+AttachmentExtractor&amp;oq=Thunderbird+AttachmentExtractor&amp;aq=f&amp;aqi=g-K1g-bK1g-bsK2&amp;aql=&amp;gs_l=serp.3..0i30j0i8i30j0i8i10i30l2.16790.18962.0.19296.3.3.0.0.0.0.675.1026.0j1j1j5-1.3.0...0.0.DzrE3JXj8W0" target="_blank">AttachmentExtractor</a> add-on to generate filenames that I could recognize and connect with specific emails, I selected all those newly imported EMLs, right-clicked on them, and chose Extract from Selected Messages to (0) Browse.  I set up a folder that was not too many levels deep, for fear that some of these attachments might already have long names that could cause problems.  AttachmentExtractor went to work.  When it was done, I deleted that folder in Thunderbird, so that I would not have a problem of confusing duplicates of EMLs that had already caused me enough grief.</div>
<div>
<br/></div>
<div>
Then, in Windows Explorer, I sorted the extracted attachments by Type.  I began the process of converting to PDF those that were not already in PDF format.  Many of these were Microsoft Word documents.  I had already worked out <a href="https://web.archive.org/web/20151121002852/http://raywoodcockslatest.blogspot.com/2012/03/batch-converting-many-microsoft-word_19.html" target="_blank">a process</a> that would automate the conversion of Word docs to PDF.  I moved these files to another workspace folder for clarity, and after making the advisable <a href="https://web.archive.org/web/20151121002852/http://raywoodcockslatest.blogspot.com/2012/06/batch-converting-many-wordstar-ws-files.html" target="_blank">adjustments</a> to my PDF printer, I applied that process to these files.<br/>
<br/>
Word had problems printing a number of these Word docs.  It crashed repeatedly, during this process, whereas it had sailed right through other stacks of docs that I had converted to PDFs by using the same techniques.  It did produce some PDFs.  I looked at those, to make sure they turned out OK, and then I had to do a DIR /a-d /b *.pdf &gt; successlist.txt in the output folder to see which docs had been successfully PDFed, and then convert successlist.txt into a batch file full of commands to delete the corresponding DOCs, so that I could try again with the DOCs that didn't convert properly the first time.  Before re-running the doc-to-pdf conversion batch file, I opened one of the failed DOCs and printed it to PDF.  That went fine, as a manual process.  So apparently it was not, in every case, a problem with the file.  Ultimately, I used OpenOffice Writer 3.2 and was able to print the remainder manually, using just a few keystrokes per file, with no problems.<br/>
<br/>
Other extracted attachments were text files.  At this point, I had two ways of dealing with these.  On one hand, I could have used the same process as I had just used with the Word docs, after changing the command used for .doc files to refer instead to .txt files.  I did start to use this approach, but ran into dialogs and potential problems.  On the other hand, I could have used the approach of printing to Notepad, as I had used with the emails themselves (above).  Before I got too far into this task, though, I noticed that every one of these text files had names like ATT3245657.txt.  They also all originated from the same source.  I examined a handful of these attachments and decided I could delete them all.<br/>
<br/>
Some extracted attachments were image files -- JPG, GIF, PNG, BMP.  I also had a dozen attachments without extensions.  I opened the latter in IrfanView.  I believe there was an IrfanView setting that allowed it to recognize, as it did, that some of these were actually image files, and to offer to rename them (as PNGs or whatever) accordingly.  On the other hand, as I looked through these files, I saw that some of the GIFs were animations.  Excluding those, I now had a list of what appeared to be all the attachments that should be treated as image files.  I used IrfanView's File &gt; Batch Conversion/Rename option to convert these to PDF.<br/>
<br/>
There were a few miscellaneous file types.  For videos, I just took a screenshot in the middle and used that as an indication of what the original attachment had been.  One alternative would have been to use something like <a href="https://web.archive.org/web/20151121002852/http://raywoodcockslatest.blogspot.com/2011/11/documenting-computer-work-with.html">Shotshooter.bat</a> to produce multiple images conveying a sense of the direction of the images in the video, and then combine those images in a single PDF.<br/>
<br/>
<b>Combining Email and Attachment PDFs</b><br/>
<br/>
Now I had everything in PDF format.  I used Bulk Rename Utility to rename emails and attachments so that, when combined into one folder, each email would come before its associated attachments (if any), and the difference between the two would be readily visible.  I combined the files and attachments into one folder and made a list of the files using DIR (above).<br/>
<br/>
Now the goal was to combine the emails that did have attachments with their accompanying attachments.  There were probably too many of these to combine them manually, one set at a time, using Acrobat or something like it.  I had previously worked out <a href="https://web.archive.org/web/20151121002852/http://raywoodcockslatest.blogspot.com/2012/02/batch-merging-many-scattered-jpgs-into_14.html">a convoluted approach</a> for automating the merger of multiple PDFs (produced from multiple JPGs), using <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?q=pdfsam&amp;ie=utf-8&amp;oe=utf-8&amp;aq=t&amp;rls=org.mozilla:en-US:official&amp;client=firefox-a">pdfSAM</a>.  Discussion on <a href="https://web.archive.org/web/20151121002852/http://superuser.com/questions/34284/combine-merge-pdf-files-in-windows" target="_blank">a SuperUser webpage</a> and elsewhere suggested that <a href="https://web.archive.org/web/20151121002852/http://www.pdflabs.com/tools/pdftk-the-pdf-toolkit/" target="_blank">pdftk</a> and <a href="https://web.archive.org/web/20151121002852/https://www.google.com/search?q=Ghostscript&amp;ie=utf-8&amp;oe=utf-8&amp;aq=t&amp;rls=org.mozilla:en-US:official&amp;client=firefox-a" target="_blank">Ghostscript</a> were alternatives.  The <a href="https://web.archive.org/web/20151121002852/http://www.ghostscript.com/doc/current/Use.htm#PDF" target="_blank">instructions for Ghostscript</a> looked more complex than <a href="https://web.archive.org/web/20151121002852/http://www.pdflabs.com/docs/pdftk-cli-examples/" target="_blank">those for pdftk</a>, so I decided to start with pdftk.<br/>
<br/>
I <a href="https://web.archive.org/web/20151121002852/http://www.pdflabs.com/docs/install-pdftk/" target="_blank">downloaded</a> and unzipped pdftk.  As <a href="https://web.archive.org/web/20151121002852/http://www.pdflabs.com/docs/install-pdftk/" target="_blank">advised</a>, I copied the two files from its bin folder (pdftk.exe and libiconv2.dll) into C:\Windows\System32.  I opened a command prompt in some other folder, at random, and typed "pdftk --help."  This was supposed to give me the <a href="https://web.archive.org/web/20151121002852/http://www.pdflabs.com/docs/pdftk-man-page/" target="_blank">documentation</a>.  Instead, it gave me an error:<br/>
<blockquote class="tr_bq">
pdftk.exe - System Error 

The program can't start because libconv2.dll is missing from your computer.  Try reinstalling the program to fix this problem.</blockquote>
I moved the two files to C:\Windows and tried again.  That worked:  I got documentation.  It scrolled on past the point of recovery.  Typing "pdftk --help &gt; documentation.txt" solved the problem, but ultimately it didn't seem to give me anything more than already existed in pdftk's docs subfolder.  The next step was to put pdftk to work.  It would apparently allow me to specify the files to combine, using a command of this form:<br/>
<blockquote class="tr_bq">
pdftk 1.pdf 2.pdf 3.pdf cat output 123.pdf</blockquote>
My problem was that, at least in some cases, the filenames I was working with were too long to fit on a single line like that, one after the other.  I decided a solution would be to take a directory listing, put it into Excel, and use it to create commands for a batch file that would rename the emails and their accompanying attachments, with names like 0001.pdf.  I would need to keep the spreadsheet for a while, so as to know what the original filenames were.  The original filenames were my guide as to what files needed to be combined together.  For this purpose, with one of the original filenames in spreadsheet cell A1, I put the ascending file numbers in cells B1, B2 ... (i.e., 1, 2, ...) and then, in cell C1, I put =REPT("0",4-LEN(B1))&amp;B1&amp;".pdf".  Finally, in cell D1, I put ="ren "&amp;CHAR(34)&amp;A1&amp;CHAR(34)&amp;" "&amp;C1.  Then I copied the formulas from column D into Notepad, saved them as Renamer.bat, and ran it.<br/>
<br/>
After doing that renaming, I went back to the spreadsheet for guidance on which of these numbers needed to be combined.  Each original filename began with date and time.  With few exceptions, this was sufficient to distinguish one email and its attachments from another.  So I used =LEFT to extract that identifying information from column A.  Then, in the next columns, I used IF statements to compare the extract from one line to the next, concatenate the appropriate filenames with a space between them, and choose which concatenations I would be using.  Finally, I added a column to create the appropriate command for the batch file.  Instead of the 123.pdf output shown in the example above, I used the original email filename.  Where there were no attachments, pdftk would thus just convert the numbered PDF (e.g., 0001.pdf) back to its original name.<br/>
<br/>
I finished with spot checks of various files, with and without attachments, to verify that they had come through the process OK.  I was not happy with the remaining junk in the emails themselves, but at least I could tell what they were about now, and they had their attachments with them.  Pdftk had proved to be a much easier tool for this project than pdfSAM.  This had been an awful lot of work for not terribly much achievement on some not very important files, but at least I had finally worked through all of the steps in the PDF conversion process for Thunderbird emails with attachments.</div>
</div>
</div>
</p>
<div style="clear: both;"></div>
</div>

---
### Comments
**raywood**:
A later postpresents a use of TexFinderX used to update multiple blog posts in a bulk process.

**TomTrottier**:
I find PSPAD editor good for bulk changes. You could always use SED for multiple changes.tOM

