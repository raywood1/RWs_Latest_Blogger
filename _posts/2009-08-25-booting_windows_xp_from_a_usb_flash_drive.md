---
layout: post
title: "Booting Windows XP from a USB Flash Drive"
date: 2009-08-25
---

<div class="post-body">
<p><div>I <a href="https://web.archive.org/web/20140903004114/http://raywoodcockslatest.blogspot.com/2009/08/installing-ubuntu-904-jaunty-jackalope.html">was trying</a> to install Ubuntu 9.04 (Jaunty Jackalope) without also installing Windows on a laptop computer. That is, for purposes of simplicity in ongoing operations (e.g., avoiding GRUB problems), I was trying to avoid making it a dual-boot machine. I found, however, that I also needed to run some Windows programs on the laptop (e.g., to update its firmware). The question confronting me was whether I could run those programs by booting the machine from a Windows installation on a USB flash drive (as distinct from a normal Windows installation on the computer's hard drive).

There seemed to be quite a few different options along these lines. For example, <a href="https://web.archive.org/web/20140903004114/http://www.911cd.net/forums//index.php?showtopic=20089">wimb_2</a> offered a guide to creating a multiboot USB stick that could boot DOS, Windows XP, Syslinux, and other operating systems. <a href="https://web.archive.org/web/20140903004114/http://elsaabi.blogspot.com/2009/01/part-3-create-bootable-usb-light.html">El-saabi</a>'s guide to putting WinXP on a stick used a 2GB flash drive. El-saabi also provided guides for creating a flash drive capable of <a href="https://web.archive.org/web/20140903004114/http://elsaabi.blogspot.com/2009/01/part-2-install-windows-xp-from-usb.html">installing WinXP</a> and a <a href="https://web.archive.org/web/20140903004114/http://elsaabi.blogspot.com/2009/01/create-bootable-flash.html">DOS boot</a> flash drive. There are options in other operating systems (e.g., <a href="https://web.archive.org/web/20140903004114/http://www.penlinux.com/">Penlinux</a>). You can buy a ready-made <a href="https://web.archive.org/web/20140903004114/http://www.prime-expert.com/flashboot/features.php">Flashboot</a> USB drive. As another example, <a d8cb15e4e04a14675f4="true" href="https://web.archive.org/web/20140903004114/http://www.tomshardware.com/reviews/windows-pocket,1113.html" onclick="$('form_cont').submit()">Björn Fröhlecke</a> posted <a href="https://web.archive.org/web/20140903004114/http://www.tomshardware.com/reviews/windows-pocket,1113.html">a how-to</a> on Tom's Hardware describing how to create a bootable Windows XP flash drive, with helpful details on many points. There are <a href="https://web.archive.org/web/20140903004114/http://www.blogger.com/xp%20bootable%20usb">many other</a> examples.

<div align="center">* * * * *</div>
The first guide I decided to follow was the one that Fred Langa published in <a href="https://web.archive.org/web/20140903004114/http://www.informationweek.com/news/showArticle.jhtml;jsessionid=SRO3XUPNJHLFLQE1GHOSKH4ATMY32JVN?articleID=177102794&amp;pgno=1&amp;queryText=&amp;isPrev=">an article</a> in <em>Information Week</em>.  Here is how I applied what Fred advised:<ul><li>This will only work on a USB drive between 256MB and 2GB in size. Also, a 256MB drive may not hold all of the add-ons you may decide to include in this device.</li><li>Make sure the BIOS in the machine you want to boot can boot from a USB drive. This can require you to check <a href="https://web.archive.org/web/20140903004114/http://www.informationweek.com/news/showArticle.jhtml?articleID=177102794&amp;pgno=4&amp;queryText=&amp;isPrev=">several locations</a>. A BIOS upgrade may be needed.</li><li>Create C:\Temp if it doesn't exist. Get rid of anything that is already in C:\Temp. Download <a href="https://web.archive.org/web/20140903004114/http://www.blogger.com/Windows%20Server%202003%20SP1">Windows 2003 SP1</a> (32-bit version) (329MB). Move it to C:\Temp.</li><li>Open the WinXP command line in C:\Temp (i.e., Start &gt; Run &gt; cmd &gt; OK). On the command line, type "c:" and then "cd \Temp." (Here, and always in this post, don't type the quotation marks or the ending period unless otherwise indicated.) Type the name of that SP1 download and then "-x." Example: "WindowsServer2003-KB889101-SP1-x86-ENU.exe -x." Hit Enter. Let it extract to C:\Temp.</li><li>Download <a href="https://web.archive.org/web/20140903004114/http://www.nu2.nu/pebuilder/">BartPE Builder</a> to destination folder C:\Temp\BartPE. Run BartPE Builder. You can let it get itself organized while you continue with the following steps.</li><li>Create a subfolder called C:\Temp\BartPE\srsp1.</li><li>Copy setupldr.bin and ramdisk.sy_ from C:\Temp\i386 to C:\Temp\BartPE\srsp1.</li><li>On the command line, use the "cd" command to navigate to C:\Temp\BartPE\srsp1. Type "expand -r ramdisk.sy_." Delete ramdisk.sy_.</li><li>Go back to the BartPE Builder program. Click OK, leave its default settings as-is, and click Build. When it's finished, click Close and Exit.</li><li>Plug in your USB drive. Look at Windows Explorer to see which drive letter is assigned to the USB drive. In my case, the letter was J.</li><li>On the command line, navigate to C:\Temp\BartPE. Type "pe2usb -f J:" (replacing J with the drive letter for your USB drive).</li><li>Eject the USB drive from the computer. Plug it into the computer you want to boot from USB. Boot that computer.</li></ul><p>The resulting USB stick didn't work, unfortunately.  To clarify:  it might have been fine for booting a machine that was not as screwed-up as my laptop appeared to be.  I did not test it on a normal machine.  It just did not work for my purposes.
</p><p>Meanwhile, I had come across some pages describing other approaches, and went partway through their process.  Here are some notes from that.  Their first instruction was to find <a href="https://web.archive.org/web/20140903004114/http://www.google.com/search?hl=en&amp;q=DOS+download+bootable&amp;sourceid=navclient-ff&amp;rlz=1B3GGGL_enUS318US318&amp;ie=UTF-8">DOS system files</a>.  I used <a href="https://web.archive.org/web/20140903004114/http://www.bootdisk.com/bootdisk.htm">DOS 6.22</a>. That particular download came in .exe format (boot622.exe). When I ran it, it looked for a floppy drive to install itself onto. I didn't have a floppy drive, so I used a <a href="https://web.archive.org/web/20140903004114/http://www.google.com/search?hl=en&amp;q=%22virtual+floppy%22+xp+%22drive+a%22&amp;sourceid=navclient-ff&amp;rlz=1B3GGGL_enUS318US318&amp;ie=UTF-8">virtual floppy drive</a> creator program named <a href="https://web.archive.org/web/20140903004114/http://webscripts.softpedia.com/script/Development-Scripts-js/Complete-applications/Virtual-Floppy-Drive-39797.html">Virtual Floppy Drive</a> (VFD). But I couldn't get VFD to see the virtual floppy drive as drive A, so it didn't function as a substitute for drive A. Then download the <a href="https://web.archive.org/web/20140903004114/http://www.google.com/search?hl=en&amp;q=%22HP+USB+Disk+Storage+Format+Tool%22&amp;sourceid=navclient-ff&amp;rlz=1B3GGGL_enUS318US318&amp;ie=UTF-8">HP USB Disk Storage Format Tool</a>. If the download is in .rar or other compressed format, extract the .exe file. El-saabi used a file called HPusbUtil.exe. I didn't preserve the original name of the one I used, but it was 2026KB in size. Install the HP USB Disk Storage Format Tool.  (That's as far as I got before taking a whole new approach, as described below.)
</p><p align="center">* * * * *</p>On the second attempt, I decided to try <a href="https://web.archive.org/web/20140903004114/http://elsaabi.blogspot.com/2009/01/part-2-install-windows-xp-from-usb.html">el-saabi's guide</a> for creating a USB flash drive capable of installing WinXP.  This guide had been created within the past eight months, by someone who described himself as a senior software developer, so I thought it might be worth trying. It didn't work on my screwed-up laptop either; but, again for posterity, the steps in his process were as follows:
<ol><li>On a computer running Windows (not necessarily the one where you will be installing Windows XP from a USB stick), open Windows Explorer (not Internet Explorer).  Plug a USB flash drive into that computer and make sure it shows up in Windows Explorer.  (I used a 4GB SanDisk USB jump drive.)  If Windows needs to reboot in order to "Finish installing devices," do that.
</li><li>In Windows Explorer, create a new folder called C:\bootusbxp.</li><li>Download <a href="https://web.archive.org/web/20140903004114/http://www.google.com/search?hl=en&amp;safe=off&amp;rlz=1B3GGGL_enUS318US318&amp;num=50&amp;newwindow=1&amp;q=petousb+download+3.0.0.7&amp;aq=f&amp;oq=&amp;aqi=">PeToUSB 3.0.0.7</a> and <a href="https://web.archive.org/web/20140903004114/http://www.google.com/search?hl=en&amp;q=usb_prep8&amp;sourceid=navclient-ff&amp;rlz=1B3GGGL_enUS318US318&amp;ie=UTF-8">usb_prep8</a> and <a href="https://web.archive.org/web/20140903004114/http://www.google.com/search?hl=en&amp;safe=off&amp;rlz=1B3GGGL_enUS318US318&amp;num=50&amp;newwindow=1&amp;q=bootsect+download&amp;btnG=Search&amp;aq=f&amp;oq=&amp;aqi=g2">bootsect</a> from a safe location (e.g., 2shared.com) and move them to C:\bootusbxp.</li><li>Unzip each of these three downloads.  (To unzip, right-click on the file in Windows Explorer and choose Extract All.)  So now you have folders called C:\bootusbxp\PeToUSB_3.0.0.7, C:\bootusbxp\usb_prep8, and C:\bootusbxp\bootsect.</li><li>If the unzip created redundant nested folders, eliminate the redundancy.  So, for example, if unzipping usb_prep8 gave you a folder called C:\bootusbxp\usb_prep8\usb_prep8 that contains a bunch of files, move those files up one level so that they are at C:\bootusbxp\usb_prep8\.  In that example, you should now have a file whose full pathname is C:\bootusbxp\usb_prep8\boot.ini.</li><li>Move C:\bootusbxp\PeToUSB_3.0.0.7\PeToUSB.exe so that it is now C:\bootusbxp\usb_prep8\PeToUSB.exe.</li><li>Run C:\bootusbxp\usb_prep8\usb_prep8.cmd.  To run an executable file (e.g., .cmd, .exe, .bat) in Windows Explorer, hit Enter when it is selected, or double-click on it.  This opens a black-and-white command window.  Press any key to start PeToUSB.  Make sure your target USB flash drive is designated.  Click Start to format it.  Leave PeToUSB up and running for now - that is, don't close it.
</li><li>Open a WinXP command window (Start &gt; Run &gt; cmd).  In that window, navigate to C:\bootusbxp\bootsect.  (To do that, type C: and hit Enter; then type "cd \bootusbxp\bootsect" and hit Enter.)  Type "<strong style="font-weight: normal;">bootsect.exe /nt52 G:" (replacing G with the actual letter for your jump drive as shown in Windows Explorer) and hit Enter.  You should get a "successfully updated" message.  Close the command window.  Now close the PeToUSB program window, but not the command window that it was opened from.
</strong></li><li>Insert your Windows XP installation CD.  If it autostarts, kill that.  Look at the command window that remains open.  It should show a menu of options labeled "Prepares Windows XP LocalSource for Copy to USB-Drive."</li><li>From that menu, choose option 1, "Change USB Setup Source Path."  Browse to your Windows XP CD and click OK.</li><li>Now choose option  3, "Change Target USB-Drive Letter."  Type the letter of your USB drive.</li><li>Now choose option 4, "Make New Tempimage with XL LocalSource and Copy to USB-Drive."  When asked, proceed with format.  In this process, there will be a few times when you will again have to press a key or click a button to continue.  Altogether, this stage takes around 15 minutes.
</li><li>Say Yes to the questions about "Preferred Boot Drive U:" and "Unmount the Virtual Drive."  Press any key (a couple of times) to close the command window.
</li></ol>Steps 1-6 seemed to involve a one-time setup.  That is, it appeared possible to program a number of additional bootable USB flash drives by repeating steps 7-13, which could be done quickly.  To test that, I did use those last seven steps to set up another USB jump drive, this time on a generic 2GB flash drive.

Once that was done, I moved the jump drive over to the computer I wanted to boot from USB.  I started that computer. When given a choice between GUI or TXT mode, I chose TXT mode, and that gave me the familiar WinXP Recovery Console.  Upon continuing with the process to install Windows XP, though, I got this error message:
<blockquote>Windows could not start because the following file is missing or corrupt:
[Windows root]\system32\hal.dll.
Please re-install a copy of the above file.</blockquote>This appeared to be <a href="https://web.archive.org/web/20140903004114/http://www.google.com/search?hl=en&amp;q=%22usb+flash%22+OR+%22usb+jump%22+OR+%22usb+thumb%22+%22install+Windows+xp%22+%22missing+or+corrupt%22+hal.dll&amp;sourceid=navclient-ff&amp;rlz=1B3GGGL_enUS318US318&amp;ie=UTF-8">a common problem</a> for bootable WinXP USB flash drives.  An old <a href="https://web.archive.org/web/20140903004114/http://msdn.microsoft.com/en-us/library/dd143260%28WinEmbedded.5%29.aspx">Microsoft webpage</a> suggested that this might result from an error in the boot.ini file, but <a href="https://web.archive.org/web/20140903004114/http://komku.blogspot.com/2008/11/install-windows-xp-using-usb-flash-disk.html">that error</a> did not seem to exist here.

<div style="text-align: center;">* * * * *
</div>
Trying a third approach, I downloaded <a href="https://web.archive.org/web/20140903004114/http://www.datafilehost.com/download-a717212e.html">WinSetupFromUSB</a>. With guidance from <a href="https://web.archive.org/web/20140903004114/http://myeeeguides.wordpress.com/2008/11/15/winsetupfromusb-install-windows-xp-from-usb-flash-drive/">installation instructions</a> that seemed to be intended for a somewhat older version of WinSetupFromUSB, I took the following steps:
<ol><li>Copy the entire contents of a Windows XP installation CD (ideally, one that includes Service Pack 3) to a new folder called C:\WINXPCD.</li><li>Plug in the USB flash drive you want to use as your bootable WinXP flash drive.
</li><li>Install WinSetupFromUSB to its default location C:\WinSetupFromUSB.  When installation finishes, start WinSetupFromUSB.
</li><li>In WinSetupFromUSB, use the Browse button to select C:\WINXPCD.  Click Refresh to make sure WinSetupFromUSB recognizes your USB drive.  This may give you an error message, such as "Warning!  You should not be using FAT16 on partitions &gt; 2GB!"  I got this error message even when using a USB drive that Windows Explorer &gt; Properties reported as being only 1.97GB.  To change the format and choose which formatting tool to use, click on the Format USB Disk &gt; RMPrepUSB button.  For that particular USB drive, I chose the FAT32 filesystem and the XP Bootable [NTLDR] boot option, with no Overrides checked.  Then I clicked on the Prepare Drive button; and after that was done, I clicked Exit.</li><li>That put me back at the WinSetupFromUSB window.  There, I clicked the GO button.  This gave me a "Could not install GRUB4DOS bootsector" error.  The error message indicated that it would try an alternative; I was not able to catch its details in time to record them here.  Possibly I should have used FAT16 rather than FAT32 after all.  But anyway, the process ran.
</li><li>When the WinSetupFromUSB process was complete, I got a dialog asking me to agree to the license terms.  Next was a dialog that said, "This is important!  Keep the USB disk plugged in AND start from USB 2 times - Text mode and GUI mode parts.  When the GUI mode (the graphical part) is completed you should be safe to start from internal disk."  It seemed that I might not have done this correctly in el-saabi's procedure (above).</li><li>Although that warning did not explicitly allow me to move the USB drive from the computer where I had been programming it to where I intended to use it, that was obviously necessary, so I did that and then tried to follow the instructions just quoted.  But in this version of the USB drive, I didn't get the same kind of menu as with el-saabi's method (above).  Instead, I got a GRUB4DOS menu with only one option:  "Windows XP/2000/2003 Setup - First and Second Parts."  Ah, but then, when I hit Enter, it gave me a list with the first part and then the second part, and when I did nothing it seemed to default to the first part.  That gave me the WinXP Professional Setup.  I hit Enter to "set up Windows XP now."  It said, as before,  that it recognized no mass storage devices.  I hit Enter again.  This time, that gave me the Windows license screen.  I hit F8 to agree.  Now I was again given an option to install WinXP on the USB drive - which, of course, I did not wnat to do.  I saw no alternative but to hit F3 to quit.  The system again gave me the GRUB4DOS menu; and when I did nothing, it defaulted into the Second Part of the setup.  Again, though, it gave me the "Windows could not start because the following file is missing or corrupt" error.
</li></ol><div style="text-align: center;">* * * * *
</div>
About this time, I came across one possible explanation for the failures of these several methods for creating a bootable WinXP USB flash drive.  When I had obtained this laptop, it had come with a factory-installed recovery partition.  I had wanted a clean drive and a Windows XP system.  So I had wiped off all partitions - or so I thought - using a Gparted CD.  But <a href="https://web.archive.org/web/20140903004114/http://www.mydigitallife.info/2008/02/29/delete-and-remove-to-unlock-eisa-hidden-recovery-or-diagnostic-partition-in-vista/">My Digital Life</a> said that the factory-installed <a href="https://web.archive.org/web/20140903004114/http://www.google.com/search?hl=en&amp;safe=off&amp;rlz=1B3GGGL_enUS318US318&amp;num=50&amp;newwindow=1&amp;q=%22hidden+partition%22+vista&amp;aq=f&amp;oq=&amp;aqi=">hidden partition</a> could evade detection and removal even by advanced third-party disk partitioning programs.

In response, one <a href="https://web.archive.org/web/20140903004114/http://www.merchantcircle.com/blogs/Fowler.Computer.603-343-8331/2009/2/Hal.dll-errors...What-to-try-when-Hal.dll-is-corrupted-or-missing./175165">kludge solution</a> would have been to leave such a partition in place, but <a href="https://web.archive.org/web/20140903004114/http://en.kioskea.net/faq/sujet-1343-hal-dll-corrupt-or-missing">edit boot.ini</a> so that it would refer to partition(2) instead of partition(1).  But I preferred to make sure that this hidden partition (if there was one) would not haunt me in the future.  In that case, My Digital Life advised a <a href="https://web.archive.org/web/20140903004114/http://download.microsoft.com/download/win2000platform/DiskPart/1.00.0.1/NT5/EN-US/diskpart_setup.exe">direct download</a> of Microsoft's <a href="https://web.archive.org/web/20140903004114/http://www.mydigitallife.info/2007/09/26/diskpartexe-free-for-windows-xp-2003-and-2000-direct-download-link/">DiskPart.exe</a> for pre-Vista versions of Windows.  I did so.  To try it out, I installed it and ran it (Start &gt; Run &gt; diskpart.exe) on a working WinXP computer.  It gave me the usual DOS-like inscrutable prompt, only this prompt said simply "DISKPART."  <a href="https://web.archive.org/web/20140903004114/http://forum.notebookreview.com/showthread.php?p=2367169#post2367169/">Hypertrophy</a> said that the first command to use was "list disk."  At the DISKPART prompt, I typed "diskpart /?" for a list of DiskPart commands.  "List" was one of the commands in that list, but I was not sure what "disk" did.  At the DISKPART command prompt, I typed "list /?" and got the information that "list disk" would print out a list of disks.  I thought I might actually prefer a list of partitions or volumes, which were the other two list options.  A <a href="https://web.archive.org/web/20140903004114/http://support.microsoft.com/kb/300415">Microsoft webpage</a> on DiskPart command syntax suggested that "detail" might be a more useful command than "list," for my purposes, so I tried that.  Following their lead, I began with "select disk 0" and then "detail disk."  This did appear to be a program that I could use to detect and delete a hidden partition on the target laptop, if there was one there.  The only problem was that I had to be able to run WinXP on that computer in order to run DiskPart.exe, and I hadn't yet succeeded in doing that.

It occurred to me that <a href="https://web.archive.org/web/20140903004114/http://en.wikipedia.org/wiki/BartPE">BartPE</a> might be able to handle this kind of situation.  I went back to el-saabi, this time to <a href="https://web.archive.org/web/20140903004114/http://elsaabi.blogspot.com/2009/01/part-3-create-bootable-usb-light.html">his guide</a> on putting BartPE on a USB stick.  This guide called for some steps that were similar to those recommended by Fred Langa (above), refined as follows:
<ol><li>Put your Windows XP CD into your CD drive.
</li><li>Create C:\BartUSB.  Download and run <a href="https://web.archive.org/web/20140903004114/http://www.nu2.nu/pebuilder/#download">BartPE Builder</a> (name of present version:  pebuilder3110a.exe).  Install it into C:\BartUSB.  So now, for example, you have a folder called C:\BartUSB\drivers.  When BartPE asks, let it search for Windows installation files.  It should find the files on the CD drive.  If it doesn't, point it that way.  Don't go any further with BartPE now.
</li><li>Download srsp1.zip (or srsp1.rar, another zip-like format).  This srsp1 file contains just the files we need, which is faster than downloading the whole Service Pack as called for in the Fred Langa approach (above).  (The "Extract All" right-click option in Windows XP does not open .rar files, but <a href="https://web.archive.org/web/20140903004114/http://www.7-zip.org/">7-Zip</a> does.)  Unzip the contents of the srsp1 file  to C:\BartUSB.  So now you have a folder named C:\BartUSB\srsp1, and that folder contains two files:  ramdisk.sys and setupldr.bin.
</li><li>If your WinXP CD has service pack 2 or service pack 3 included, click on BartPE's Plugins button and enable "RpcSS needs to launch DComLaunch Service first - SP2 only."  Then click on Close and then Build, and let it go through its steps.  When the Build is done, close and exit.
</li><li>Plug a USB drive (size:  256MB to 2GB) into the computer you will be using to make the BartPE stick.  In Windows Explorer, take note of its drive letter.  On the command line, navigate to C:\BartUSB. Type "pe2usb -f J:" (replacing J with the drive letter for your USB drive).  Type YES and so forth, as prompted, to finish the process.</li><li>Eject the USB drive from the computer. Plug it into the computer you want to boot from USB. Boot that computer.</li></ol>This setup took only 157MB on my 256MB flash drive.  Unfortunately, the result was still not bootable.  It gave me <a href="https://web.archive.org/web/20140903004114/http://www.google.com/search?hl=en&amp;safe=off&amp;rlz=1B3GGGL_enUS318US318&amp;num=50&amp;newwindow=1&amp;q=grub+%22error+15%22+usb+drive+flash+OR+jump+OR+thumb&amp;aq=f&amp;oq=&amp;aqi=">GRUB Error 15</a>.  When I removed the thumb drive, Ubuntu booted normally.  Even if it had booted, I was not yet entirely sure how I would run DiskPart.exe.

Again, note that I was looking for a bootable USB drive that would fix problems that appeared to stem from an imperfect removal of the factory-installed recovery partition on a hard drive that had originally been home to a Windows Vista installation.  I had to conclude, at this point, that I lacked the knowledge and time required to prepare a USB flash drive that would tackle this problem effectively.  Based upon my knowledge at this point, it was unfortunately necessary, then, to wipe the hard drive and reinstall the partitions in order to eliminate this problem.
<p></p></div></p>
<div style="clear: both;"></div>
</div>

---
### Comments
**rax**:
hi,thanx for providing this useful information.usb boot drive

