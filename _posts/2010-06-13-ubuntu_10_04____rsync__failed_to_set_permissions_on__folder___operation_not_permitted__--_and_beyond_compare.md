---
layout: post
title: "Ubuntu 10.04:  'rsync: failed to set permissions on [folder]: Operation not permitted' -- and Beyond Compare"
date: 2010-06-13
---

<div class="post-body">
<p><a href="https://web.archive.org/web/20130520224315/http://raywoodcockslatest.blogspot.com/2009/12/ubuntu-backup-with-rsync.html">Using rsync</a> to automate backups on Ubuntu 10.04 (Lucid Lynx), I got a million iterations of this message:  "rsync: failed to set permissions on [target drive &amp; folder]: Operation not permitted." <br/>
<br/>
I had previously had a <a href="https://web.archive.org/web/20130520224315/http://raywoodcockslatest.blogspot.com/2009/12/rsync-usb-drive-error-30-read-only-file.html">somewhat similar problem</a> with an external USB drive.  The solution there had been to reformat the drive.  I didn't want to have to do that again if it wasn't necessary.  I ran <a href="https://web.archive.org/web/20130520224315/http://www.google.com/search?num=50&amp;hl=en&amp;newwindow=1&amp;safe=off&amp;client=firefox-a&amp;hs=PSC&amp;rlz=1R1GGGL_en___US333&amp;q=rsync+%22failed+to+set+permissions%22+%22operation+not+permitted%22+-tiger&amp;btnG=Search">a search</a> and, following what i understood from one post, I set out to change ownership on the target folder so as to match the ownership of the source folder.  To do that, I went into Ubuntu's Terminal and typed "sudo nautilus," and then navigated Nautilus to File System/media/[target drive].  (It could instead have been in File System/mnt/.)  I right-clicked on that and got Properties &gt; Permissions.  The owner was root.  When I tried to change it, it changed back.<br/>
<br/>
I exited Nautilus and followed <a href="https://web.archive.org/web/20130520224315/https://help.ubuntu.com/community/FilePermissions#Changing%20the%20File%20Owner%20and%20Group">instructions</a> in Ubuntu Community Documentation, combined with advice from <a href="https://web.archive.org/web/20130520224315/https://lists.ubuntu.com/archives/ubuntu-users/2005-August/045181.html">another post</a> and the <a href="https://web.archive.org/web/20130520224315/http://manpages.ubuntu.com/manpages/lucid/man1/chown.1.html">Ubuntu manual</a> page for chown.  I typed "sudo chown -R ray /media/[target drive]."  That ran for five or ten minutes, as the chown (change ownership) command recursed (i.e., -R) all of the subdirectories on the target drive.  But that, by itself, did not fix the problem; indeed, it didn't seem to change anything.  Root was still the owner of the target drive.  Then again, the properties of the target allowed others to create and delete files as well, so why was rsync complaining?<br/>
<br/>
There appeared to be <a href="https://web.archive.org/web/20130520224315/https://help.ubuntu.com/community/Fstab">another way</a>.  In Terminal, I typed "sudo gedit /etc/fstab."  I already had a line for the target drive, which I'll call simply TARGET.  That line was as follows:<br/>
<br/>
UUID=[UUID for the drive] /media/TARGET ntfs-3g defaults,umask=000 0 0<br/>
<br/>
The Ubuntu documentation I was now looking at said, "Permissions are set at the time of mounting the partition with umask, dmask, and fmask and can not be changed with commands such as chown or chmod."  So possibly that's why my chown command wasn't doing anything.  Following the advice, I changed it to dmask=027,fmask=137, since this was going to be just a backup drive anyway.  I also saw that "defaults" meant these options:  rw,suid,dev,exec,auto,nouser,async.  All of those were fine, as far as I knew, except for this information from the documentation:<br/>
<blockquote>user - Permit any user to mount the filesystem. This automatically implies noexec, nosuid,nodev unless overridden.<br/>
<br/>
nouser - Only permit root to mount the filesystem. This is also a default setting.</blockquote>I wanted user, not nouser.  I decided it might be easier to spot this sort of thing, in future visits to fstab, if I just changed all occurrences of "defaults" to make these options explicit.  Besides, in light of the statements just quoted, it seemed that I would have to override several defaults anyway.  So the resulting fstab line looked like this:<br/>
<br/>
UUID=[UUID for the drive] /media/TARGET ntfs-3g rw,suid,dev,exec,auto,user,async,dmask=027,fmask=137 0 0<br/>
<br/>
I saved fstab and, in Terminal, typed "sudo mount -a" to mount the partitions according to these new instructions.  Then I ran the rsync command again.  Sadly, these changes made no visible difference.  I still got a million error messages.  So, OK.  I had been overlooking the first three error lines in the log output of my rsync command.  The second and third lines followed the pattern of this first line, but were for subdirectories:<br/>
<br/>
rsync: failed to set times on /media/TARGET/.": Operation not permitted (1)<br/>
<br/>
I hadn't previously investigated the "failed to set times" error, so now I did.  What I got out of the forums I came across was that possibly I had a syntax error in my rsync command.  Here's how it went:<br/>
<br/>
rsync -qhlEtrip --progress --delete-after --ignore-errors --force --exclude=/.Trash-0 --exclude=/.Trash-1000/ --exclude=/lost+found/ /media/SOURCE /media/TARGET 2&gt; /media/SOURCE/Backuplog.log<br/>
<br/>
This was identical to the perfectly working rsync command that I was occasionally using to back up SOURCE to a different partition, with one exception:  in the one shown above, I didn't have a slash after Trash-0.  So I changed that to --exclude=/.Trash-0/ and re-ran it.  That didn't solve it.  I then noticed (I was using two desktops) that I had gotten a message telling me that the system was not able to mount the partition:  "Device or resource busy."  So possibly that fstab step still needed to be tested.  I rebooted the system.  None of the the parittions that I had adjusted in fstab were mounted.  I went back, deleted the dmask and fmask parts, and returned it to umask=000, and rebooted.  Now the partitions were all mounted.  I ran the rsync command again.  The problem had not changed. <br/>
<br/>
I found <a href="https://web.archive.org/web/20130520224315/http://ubuntuforums.org/archive/index.php/t-87038.html">an informative thread</a> in which bscbrit suggested trying to use cp to copy a single file from the source partition to the target partition.  If it worked, s/he said, the problem was not with permissions; it was just with trying to use rsync.  So in SOURCE I copied a file, renamed it "x.txt," and typed "cp /media/SOURCE/x.txt /media/TARGET," and it worked:  there was a copy of x.txt on TARGET.  It sounded like there could be a kind of mismatch between the ext3 source drive and the ntfs target.  I also came across an informative post by <a href="https://web.archive.org/web/20130520224315/http://ubuntuforums.org/showpost.php?p=6516811&amp;postcount=34">djgrandmarquis</a> that said rsync could have problems with Windows file systems.  That was in response to a question about very slow backup times, which  I had also experienced.  I needed Windows file systems because I was backing up to an offsite drive that I sometimes shared with a Windows system.<br/>
<br/>
I had previously investigated <a href="https://web.archive.org/web/20130520224315/http://raywoodcockslatest.blogspot.com/2009/12/long-term-backup-verification-beyond.html">Beyond Compare</a> (BC) as another way of synchronizing drives.  BC had drawn  <a href="https://web.archive.org/web/20130520224315/http://www.google.com/search?q=%22beyond+compare%22+&amp;ie=utf-8&amp;oe=utf-8&amp;aq=t&amp;client=firefox-a&amp;rlz=1R1GGGL_en___US333">a lot of praise</a>.  Since my previous writeup, I had bought a copy and had been using it for several months on Ubuntu, WinXP, and Linux.  I had subsequently found <a href="https://web.archive.org/web/20130520224315/http://en.wikipedia.org/wiki/Comparison_of_file_comparison_tools">a comparison</a> of many such programs; but since I had already bought BC and was using it with good results, I didn't explore that comparison.  I could verify that BC was fast and trouble-free when compared to rsync, especially when going between ext3 and ntfs drives.  I also liked the visible information about what was being changed and backed up.  So I decided to stop using rsync and start relying only on BC for my backups.<br/>
<br/>
There were a few differences between the Windows and Linux versions of BC; but in an impressively thorough reply to my post, Craig from BC said that the portable version of BC ran well on <a href="https://web.archive.org/web/20130520224315/http://www.google.com/search?q=wine+ubuntu&amp;ie=utf-8&amp;oe=utf-8&amp;aq=t&amp;client=firefox-a&amp;rlz=1R1GGGL_en___US333">Wine</a> in Ubuntu.  I had already installed Wine, and I had also already been using the portable version of BC3; I preferred portable versions to save time during reinstallations, as I was able to save them elsewhere than drive C and therefore they weren't wiped out during a Windows reinstall.  So to try this out, I copied over the BC3 portable installation and tried using a <a href="https://web.archive.org/web/20130520224315/http://raywoodcockslatest.blogspot.com/2010/06/ubuntu-1004-irfanview-and-other.html">funky procedure</a> involving PortableApps to try the Windows version.  But now it seemed I had not properly understood or used that procedure:  PortableApps now appeared to be looking, not for .exe files, but for ".paf exe" files.  Meanwhile, it looked like Beyond Compare 3 would run fairly well <a href="https://web.archive.org/web/20130520224315/http://appdb.winehq.org/objectManager.php?sClass=version&amp;iId=18009&amp;iTestingId=50153">under Wine</a>, so I gave it a try.  Following the steps described in that <a href="https://web.archive.org/web/20130520224315/http://raywoodcockslatest.blogspot.com/2010/06/ubuntu-1004-irfanview-and-other.html">previous post</a>, in Terminal I navigated to the folder where I had the original BC installer, typed "ls" to get the exact filename, and typed "wine BCompare-3.1.10.11626.exe" to install that file.  Terminal reported some "fixme" and "err" messages; nonetheless, the Beyond Compare 3 Setup Wizard ran.  I had a licensed version, so I entered the license key, and followed the instruction to restart.  It worked, but now I came to the new realization that Windows identifies drives by letter (C: etc.), while Ubuntu identifies them by name (/media/DATA, etc.).  So of course a Windows version of Beyond Compare, looking for Windows-type folder paths, running in Ubuntu, is going to find only a limited number of Ubuntu locations.  I didn't pursue that problem.<br/>
<br/>
This left at least one issue unresolved.  While I was OK with doing manual comparisons for now, I was still not at the point of being able to write <a href="https://web.archive.org/web/20130520224315/http://www.scootersoftware.com/vbulletin/forumdisplay.php?f=17">scripts</a> to automate BC backup processes.  I started <a href="https://web.archive.org/web/20130520224315/http://raywoodcockslatest.blogspot.com/2010/06/beyond-compare-mirroring-scripts.html">another post</a> on that.</p>
<div style="clear: both;"></div>
</div>

---
### Comments
**raywood**:
I posted a question about that Ubuntu-Windows folder mismatch problem in a Scooter Software (Beyond Compare) forum.  See http://www.scootersoftware.com/vbulletin/showthread.php?p=24394#post24394

**mahmudin ashar**:
sometime i trough the same thing, it's happend because file/folder/data i want to backup is owened by root or other user different with user run my rsync

**Anonymous**:
It sounds like you were trying to set UNIX permissions on the NTSF file system. It would probably work if you removed the copy permissions option.

